<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Workflow Synthesizer - Unified Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0f0f23;
      color: #e0e0e0;
    }
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .header h1 { font-size: 32px; margin-bottom: 5px; }
    .header p { opacity: 0.9; font-size: 14px; }
    .container { max-width: 1400px; margin: 0 auto; padding: 30px; }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #2a2a3e;
      transition: transform 0.3s;
    }
    .stat-card:hover { transform: translateY(-5px); }
    .stat-label {
      font-size: 13px;
      opacity: 0.7;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    .stat-value { font-size: 36px; font-weight: 700; color: #667eea; }
    .stat-icon { font-size: 40px; float: right; opacity: 0.3; }
    .section {
      background: #1a1a2e;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #2a2a3e;
      margin-bottom: 20px;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .section-title { font-size: 20px; font-weight: 600; }
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-online { background: rgba(76, 175, 80, 0.2); color: #4CAF50; }
    .status-offline { background: rgba(244, 67, 54, 0.2); color: #f44336; }
    .event-list { max-height: 400px; overflow-y: auto; }
    .event-item {
      background: #0f0f23;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #667eea;
    }
    .event-header { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .event-type { font-weight: 600; color: #667eea; }
    .event-time { font-size: 12px; opacity: 0.6; }
    .workflow-item {
      background: #0f0f23;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .workflow-query { flex: 1; }
    .workflow-status {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 11px;
      background: rgba(76, 175, 80, 0.2);
      color: #4CAF50;
    }
    .delete-btn {
      background: rgba(244, 67, 54, 0.2);
      color: #f44336;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
    }
    .delete-btn:hover { background: rgba(244, 67, 54, 0.4); }
    .empty-state { text-align: center; padding: 40px; opacity: 0.5; }
  </style>
</head>
<body>
  <div class="header">
    <h1>‚ö° Syntra Dashboard</h1>
    <p>Monitor your automated workflows</p>
  </div>
  
  <div class="container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-label">Total Events</div>
        <div class="stat-value" id="totalEvents">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">‚úâÔ∏è</div>
        <div class="stat-label">Email Events</div>
        <div class="stat-value" id="emailEvents">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">üìÅ</div>
        <div class="stat-label">File Events</div>
        <div class="stat-value" id="fileEvents">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">üì∞</div>
        <div class="stat-label">Article Events</div>
        <div class="stat-value" id="articleEvents">0</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon">‚ö°</div>
        <div class="stat-label">Active Workflows</div>
        <div class="stat-value" id="activeWorkflows">0</div>
      </div>
      

    </div>
    
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üìã Workflows</h2>
        <div style="display: flex; gap: 10px; align-items: center;">
          <span class="status-badge" id="llmStatus" style="background: rgba(102, 126, 234, 0.2); color: #667eea;">üß† LLM Ready</span>
          <span class="status-badge status-online" id="serverStatus">üü¢ Online</span>
        </div>
      </div>
      
      <div style="margin-bottom: 20px; padding: 15px; background: #0f0f23; border-radius: 8px; border: 1px solid #2a2a3e;">
        <div style="font-weight: 600; margin-bottom: 10px; color: #667eea;">Create Workflow</div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <input type="text" id="dashboardQuery" placeholder="e.g., When I download a PDF, summarize it and email me" 
            style="flex: 1; padding: 10px; background: #1a1a2e; border: 1px solid #2a2a3e; border-radius: 6px; color: #e0e0e0; font-size: 14px;">
          <button onclick="createWorkflowDashboard()" style="padding: 10px 15px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer;">Create</button>
        </div>
        <div id="dashboardRecommendations" style="display: none; font-size: 12px; color: #FFC107; margin-top: 10px;"></div>
      </div>
      
      <div id="workflowList">
        <div class="empty-state">No workflows yet. Create one above!</div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üìä Recent Results</h2>
      </div>
      <div class="event-list" id="resultsList">
        <div class="empty-state">
          <div style="font-size: 48px; margin-bottom: 15px;">üìù</div>
          <div>No results yet</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Results will appear here when workflows process your files or emails</div>
        </div>
      </div>
    </div>
    
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">üìä Activity</h2>
      </div>
      <div class="event-list" id="eventList">
        <div class="empty-state">
          <div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div>
          <div>No activity yet</div>
          <div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">File downloads and email events will appear here</div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    async function fetchStats() {
      try {
        const response = await fetch('http://localhost:8000/stats');
        if (response.ok) {
          const data = await response.json();
          document.getElementById('totalEvents').textContent = data.total_events;
          document.getElementById('emailEvents').textContent = data.email_events;
          document.getElementById('fileEvents').textContent = data.file_events;
          document.getElementById('articleEvents').textContent = data.article_events || 0;
          document.getElementById('activeWorkflows').textContent = data.active_workflows;

          document.getElementById('serverStatus').className = 'status-badge status-online';
          document.getElementById('serverStatus').textContent = 'üü¢ Online';
        }
      } catch (error) {
        document.getElementById('serverStatus').className = 'status-badge status-offline';
        document.getElementById('serverStatus').textContent = 'üî¥ Offline';
      }
    }
    
    async function fetchWorkflows() {
      try {
        const response = await fetch('http://localhost:8000/workflows');
        if (response.ok) {
          const data = await response.json();
          const list = document.getElementById('workflowList');
          
          if (data.workflows.length === 0) {
            list.innerHTML = '<div class="empty-state">No workflows yet. Add one from the extension!</div>';
          } else {
            list.innerHTML = data.workflows.map(w => `
              <div class="workflow-item">
                <div class="workflow-query">
                  ${w.query}

                </div>
                <div style="display: flex; align-items: center; gap: 10px;">
                  <span class="workflow-status">${w.status}</span>
                  <button class="delete-btn" onclick="deleteWorkflow(${w.id})">üóëÔ∏è</button>
                </div>
              </div>
            `).join('');
          }
        }
      } catch (error) {}
    }
    
    async function fetchResults() {
      try {
        const response = await fetch('http://localhost:8000/results');
        if (response.ok) {
          const data = await response.json();
          const list = document.getElementById('resultsList');
          
          if (data.results.length === 0) {
            list.innerHTML = '<div class="empty-state"><div style="font-size: 48px; margin-bottom: 15px;">üìù</div><div>No results yet</div><div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">Results will appear here when workflows process your files or emails</div></div>';
          } else {
            list.innerHTML = data.results.slice(-10).reverse().map((r, i) => `
              <div class="event-item" style="border-left-color: #4CAF50; cursor: pointer;" onclick="viewResult(${i})">
                <div class="event-header">
                  <span class="event-type">${getResultIcon(r)} ${r.title || 'Result'}</span>
                  <div style="display: flex; gap: 10px; align-items: center;">
                    <span class="event-time">${new Date(r.created_at).toLocaleTimeString()}</span>
                    <button onclick="event.stopPropagation(); viewResult(${i})" style="background: rgba(76, 175, 80, 0.3); border: none; border-radius: 50%; width: 30px; height: 30px; color: white; cursor: pointer; font-size: 12px;" title="View">
                      üëÅÔ∏è
                    </button>
                  </div>
                </div>
                <div>${formatResult(r)}</div>
              </div>
            `).join('');
            
            // Store results for viewing
            window.dashboardResults = data.results.slice(-10).reverse();
          }
        }
      } catch (error) {}
    }
    
    async function fetchEvents() {
      try {
        const response = await fetch('http://localhost:8000/events');
        if (response.ok) {
          const data = await response.json();
          const list = document.getElementById('eventList');
          
          if (data.events.length === 0) {
            list.innerHTML = '<div class="empty-state"><div style="font-size: 48px; margin-bottom: 15px;">üìÅ</div><div>No activity yet</div><div style="font-size: 12px; opacity: 0.7; margin-top: 5px;">File downloads and email events will appear here</div></div>';
          } else {
            list.innerHTML = data.events.slice(-20).reverse().map(e => `
              <div class="event-item">
                <div class="event-header">
                  <span class="event-type">${getIcon(e)} ${e.payload.event_type || 'file_event'}</span>
                  <span class="event-time">${new Date(e.timestamp).toLocaleTimeString()}</span>
                </div>
                <div>${formatEvent(e.payload)}</div>
              </div>
            `).join('');
          }
        }
      } catch (error) {}
    }
    
    function getIcon(event) {
      const eventType = event.payload?.event_type;
      if (eventType === 'file_download') return 'üìÅ';
      if (eventType === 'email_compose') return '‚úâÔ∏è';
      if (eventType === 'article_read') return 'üìñ';
      if (eventType === 'article_write') return '‚úçÔ∏è';
      return 'üìå';
    }
    
    function getResultIcon(result) {
      if (result.type === 'summary') return 'üìñ';
      if (result.type === 'feedback') return '‚úâÔ∏è';
      if (result.type === 'report') return 'üìÑ';
      if (result.type === 'notification') return 'üìÅ';
      return 'ü§ñ';
    }
    
    function formatResult(result) {
      if (result.type === 'result') {
        const content = (result.content || '').replace(/\*\*(.*?)\*\*/g, '$1');
        return content.substring(0, 120) + (content.length > 120 ? '...' : '');
      }
      if (result.type === 'notification') {
        return `File processed: ${result.title} (${(result.file_size / 1024).toFixed(1)} KB)`;
      }
      return 'Result generated';
    }
    
    function formatEvent(payload) {
      if (payload.event_type === 'file_download') {
        return `Downloaded: ${payload.file_name || payload.title}`;
      }
      if (payload.event_type === 'email_compose') {
        return `Email: ${payload.email_subject || payload.title}`;
      }
      if (payload.event_type === 'article_read') {
        return `Read: ${payload.article_title || payload.title}`;
      }
      return payload.description || 'Activity detected';
    }
    

    
    async function createWorkflowDashboard() {
      const query = document.getElementById('dashboardQuery').value.trim();
      if (!query) {
        alert('Please enter a workflow description');
        return;
      }
      
      try {
        const response = await fetch('http://localhost:8000/workflow', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query, use_smart: true })
        });
        
        if (response.ok) {
          alert('‚úÖ Workflow created!');
          document.getElementById('dashboardQuery').value = '';
          fetchWorkflows();
          fetchStats();
        }
      } catch (error) {
        alert('Server not running');
      }
    }
    
    async function deleteWorkflow(id) {
      if (confirm('Delete this workflow?')) {
        await fetch(`http://localhost:8000/workflow/${id}`, { method: 'DELETE' });
        fetchWorkflows();
        fetchStats();
      }
    }
    
    // Auto-refresh
    setInterval(() => {
      fetchStats();
      fetchWorkflows();
      fetchResults();
      fetchEvents();
    }, 2000);
    
    function viewResult(index) {
      const result = window.dashboardResults[index];
      if (!result) return;
      
      let content = '';
      if (result.type === 'result') {
        content = (result.content || 'No content available').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
      } else if (result.type === 'notification') {
        content = `<strong>File:</strong> ${result.title}<br><strong>Size:</strong> ${(result.file_size / 1024).toFixed(1)} KB<br><strong>Message:</strong> ${result.message}`;
      }
      
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;';
      modal.innerHTML = `
        <div style="background: #1a1a2e; border-radius: 12px; padding: 30px; max-width: 600px; max-height: 80vh; overflow-y: auto; position: relative;">
          <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: #e0e0e0; font-size: 20px; cursor: pointer;">√ó</button>
          <h3 style="margin: 0 0 20px 0; color: #667eea;">Result Details</h3>
          <div style="line-height: 1.6; color: #e0e0e0;">${content}</div>
          <div style="margin-top: 20px; text-align: center;">
            <button onclick="copyToClipboard('${result.content?.replace(/'/g, "\\'") || ''}')" style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-right: 10px;">Copy</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text.replace(/\\'/g, "'")).then(() => {
        alert('Copied to clipboard!');
      });
    }
    
    // Initial load
    fetchStats();
    fetchWorkflows();
    fetchResults();
    fetchEvents();
  </script>
</body>
</html>
